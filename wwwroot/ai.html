<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title data-translate="ai.title">AI Assistant - Internship Application Manager</title>
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="styles.css" rel="stylesheet" />
  <style>
    html {
      overflow-y: scroll !important;
    }
    body {
      overflow-y: auto !important;
    }
  </style>
    <style>
      .site-header {
        position: relative;
      }
      .help-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #3b82f6;
        background: #3b82f6;
        color: white;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1001;
      }
      .help-btn:hover {
        background: #2563eb;
        border-color: #2563eb;
        transform: scale(1.1);
      }
      .ai-flex-row {
        display: flex;
        gap: 32px;
        width: 100%;
      }
      .ai-card,
      .ai-history-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: box-shadow 0.2s, transform 0.15s;
      }
      .ai-card,
      .ai-history-card {
        margin: 2em 0;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .ai-card {
        padding: 2em;
        max-width: 700px;
        width: 100%;
        flex: 1 1 60%;
      }
      .ai-history-card {
        padding: 1.5em 1em;
        max-width: 350px;
        width: 100%;
        overflow-y: auto;
        flex: 1 1 40%;
        gap: 1em;
      }
      .ai-card:hover,
      .ai-card:focus-within,
      .ai-history-card:hover,
      .ai-history-card:focus-within {
        box-shadow: 0 8px 32px rgba(37, 99, 235, 0.12), 0 0 0 2px #2563eb33;
        transform: translateY(-3px) scale(1.01);
      }
      .ai-history-card h4 {
        text-align: center;
        margin-bottom: 1em;
      }
      .ai-history-entry {
        background: #f8fafc;
        border-radius: 10px;
        padding: 0.75em 1em;
        margin-bottom: 0.5em;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        cursor: pointer;
        transition: background 0.15s, box-shadow 0.15s, transform 0.15s;
      }
      .ai-history-entry:hover {
        background: #e0e7ff;
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px) scale(1.01);
      }
      .ai-history-entry .prompt {
        font-weight: 600;
        color: #2563eb;
        margin-bottom: 0.25em;
      }
      .ai-history-entry .response {
        color: #334155;
        margin-top: 0.25em;
      }
      #aiPrompt {
        width: 100%;
        font-size: 1.1em;
        margin-bottom: 1em;
        border-radius: 10px;
        border: 1.5px solid #cbd5e1;
        padding: 1em;
        background: #f8fafc;
        transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        min-height: 120px;
        resize: vertical;
      }
      #aiPrompt:hover,
      #aiPrompt:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1), 0 0 0 2px #2563eb33;
        background: #fff;
        transform: translateY(-2px);
      }
      #aiResponse {
        margin-top: 1em;
        white-space: pre-wrap;
        background: #f1f5f9;
        padding: 1em;
        border-radius: 8px;
        min-height: 2em;
        min-width: 100px;
        display: flex;
        align-items: center;
        gap: 0.5em;
      }
      .spinner {
        border: 3px solid #e0e7ff;
        border-top: 3px solid #2563eb;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Help Modal Styles */
      .help-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      }
      .help-modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 32px 24px;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        margin: 20px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .help-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e2e8f0;
      }
      .help-title {
        font-size: 20px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
      }
      .help-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #64748b;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
      }
      .help-close:hover {
        background: #f1f5f9;
        color: #1e293b;
      }
      .help-section {
        margin-bottom: 20px;
      }
      .help-section h4 {
        color: #3b82f6;
        font-size: 16px;
        margin: 0 0 8px 0;
        font-weight: 600;
      }
      .help-section ul {
        margin: 0;
        padding-left: 20px;
      }
      .help-section li {
        margin-bottom: 4px;
        color: #475569;
        line-height: 1.5;
      }
      .help-tip {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 12px;
        margin: 12px 0;
        border-radius: 0 6px 6px 0;
      }
      .help-tip strong {
        color: #1e40af;
      }
      @media (max-width: 1100px) {
        .ai-flex-row {
          flex-direction: column;
        }
        .ai-history-card {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Redirect to login if not authenticated -->
    <script>
      if (!localStorage.getItem('userLoggedIn')) {
        window.location.href = 'login.html';
      }
    </script>
    
    <!-- Header -->
    <div class="header-rect">
      <div class="header-inner" style="display: flex !important; justify-content: space-between !important; align-items: center !important;">
        <div>
          <div class="brand" onclick="window.location.href='index.html'" style="cursor: pointer;">Internship Application Manager</div>
          <div class="subtitle">Track your internship applications and manage your career journey</div>
        </div>
        <div class="auth-buttons">
          <button class="btn btn-sm" onclick="logout()" style="position: absolute; top: 20px; right: 20px; z-index: 1001;">Logout</button>
        </div>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="mobile-menu">
      <a href="index.html" class="mobile-menu-item" data-page="index.html">
        📋 Job Postings
      </a>
      <a href="resumes.html" class="mobile-menu-item" data-page="resumes.html">
        📄 Resumes
      </a>
      <a
        href="calendar.html"
        class="mobile-menu-item"
        data-page="calendar.html"
      >
        📅 Calendar
      </a>
      <a href="ai.html" class="mobile-menu-item active" data-page="ai.html">
        🤖 <span data-translate="nav.ai">AI Assistant</span>
      </a>
    </div>

    <!-- Help Modal -->
    <div
      id="helpModal"
      class="help-modal"
      aria-modal="true"
      role="dialog"
      tabindex="-1"
    >
      <div class="help-modal-content">
        <div class="help-header">
          <h3 class="help-title" data-translate="ai.help.title">🤖 AI Assistant Help</h3>
          <button
            id="closeHelpModal"
            class="help-close"
            aria-label="Close Help"
          >
            &times;
          </button>
        </div>
        <div class="help-section">
          <h4 data-translate="ai.help.usingChat">💬 Using the AI Chat</h4>
          <ul>
            <li data-translate="ai.help.typeQuestion">
              Type your question or prompt in the text box and click
              <b>Send</b> or press <b>Ctrl+Enter</b>.
            </li>
            <li data-translate="ai.help.conversationSaved">
              Each conversation is saved in the Chat History on the right.
            </li>
            <li data-translate="ai.help.clickPrevious">
              Click any previous chat to reload it for editing or follow-up.
            </li>
            <li data-translate="ai.help.historySaved">
              Chat history is saved until you close or refresh the browser tab.
            </li>
          </ul>
        </div>
        <div class="help-section">
          <h4 data-translate="ai.help.downloading">📄 Downloading & Exporting</h4>
          <ul>
            <li data-translate="ai.help.copyPaste">Copy and paste any AI response for your records.</li>
            <li data-translate="ai.help.downloadHistory">
              Download your chat history as a <b>.txt</b> file for backup.
            </li>
            <li data-translate="ai.help.clearHistory">
              Clear all chat history with the <b>Clear History</b> button.
            </li>
          </ul>
        </div>
        <div class="help-section">
          <h4 data-translate="ai.help.tips">💡 Tips for Best Results</h4>
          <ul>
            <li data-translate="ai.help.beSpecific">Be specific with your questions for more accurate answers.</li>
            <li data-translate="ai.help.useHistory">
              Use the chat history to compare different prompts and responses.
            </li>
            <li data-translate="ai.help.rephrase">Try rephrasing or following up for more details.</li>
            <li data-translate="ai.help.characterLimit">Keep prompts under 1000 characters for best performance.</li>
          </ul>
        </div>
        <div class="help-tip">
          <strong data-translate="ai.help.proTip">💡 Pro Tip:</strong> <span data-translate="ai.help.proTip.desc">Use the AI to draft emails, summarize job descriptions, or brainstorm interview answers!</span>
        </div>
      </div>
    </div>

    <main class="container">
      <div class="panel full-width" style="margin-top: 20px">
        <div class="ai-flex-row">
          <div class="ai-card">
            <h3 style="text-align: center" data-translate="ai.mainTitle">Local AI Assistant</h3>
            <form id="aiForm" autocomplete="off">
              <textarea
                id="aiPrompt"
                rows="5"
                maxlength="1000"
                placeholder="Ask the AI anything..." data-translate="ai.promptPlaceholder"
                aria-label="AI Prompt"
              ></textarea
              ><br />
              <button
                type="submit"
                class="btn primary"
                aria-label="Send Message"
              >
                <span data-translate="ai.send">Send</span>
              </button>
            </form>
            <div id="aiResponse" aria-live="polite"></div>
          </div>
          <div class="ai-history-card" id="aiHistoryCard">
            <h4 data-translate="ai.chatHistory">Chat History</h4>
            <div id="aiHistory"></div>
            <button id="downloadHistory" class="btn" style="margin-top: 10px">
              <span data-translate="ai.downloadHistory">Download History</span>
            </button>
            <button id="clearHistory" class="btn" style="margin-top: 10px">
              <span data-translate="ai.clearHistory">Clear History</span>
            </button>
          </div>
        </div>
      </div>
    </main>

    <script src="js/translations.js"></script>
    <script src="toast-notifications.js"></script>
    <script src="hamburger-menu.js"></script>
    <script>
      // --- Escape HTML to prevent XSS ---
      function escapeHTML(str) {
        return String(str).replace(/[&<>"']/g, function (m) {
          return (
            {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m] || m
          );
        });
      }

      // --- Authentication Management ---
      function getAuthToken() {
        return localStorage.getItem('authToken');
      }

      function getCurrentUser() {
        const userStr = localStorage.getItem('currentUser');
        return userStr ? JSON.parse(userStr) : null;
      }

      function isAuthenticated() {
        return getAuthToken() && getCurrentUser();
      }

      function redirectToLogin() {
        window.location.href = 'login.html';
      }

      // Check authentication on page load
      if (!isAuthenticated()) {
        redirectToLogin();
      }

      // --- Chat History Persistence ---
      function saveHistory(history) {
        const user = getCurrentUser();
        if (user) {
          localStorage.setItem(`aiChatHistory_${user.id}`, JSON.stringify(history));
        }
      }
      
      function loadHistory() {
        try {
          const user = getCurrentUser();
          if (user) {
            return JSON.parse(localStorage.getItem(`aiChatHistory_${user.id}`)) || [];
          }
          return [];
        } catch {
          return [];
        }
      }

      const aiForm = document.getElementById("aiForm");
      const aiPrompt = document.getElementById("aiPrompt");
      const aiResponse = document.getElementById("aiResponse");
      const aiHistory = document.getElementById("aiHistory");
      let chatHistory = loadHistory();

      function renderHistory() {
        aiHistory.innerHTML = "";
        chatHistory
          .slice()
          .reverse()
          .forEach((item, idx) => {
            const entry = document.createElement("div");
            entry.className = "ai-history-entry";
            entry.innerHTML =
              `<div class="prompt">${escapeHTML(item.prompt)}</div>` +
              `<div class="response">${escapeHTML(item.response)}</div>`;
            entry.title = "Click to reload this chat";
            entry.tabIndex = 0;
            entry.setAttribute("role", "button");
            entry.addEventListener("click", () => {
              aiPrompt.value = item.prompt;
              aiResponse.textContent = item.response;
              aiPrompt.focus();
            });
            entry.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                aiPrompt.value = item.prompt;
                aiResponse.textContent = item.response;
                aiPrompt.focus();
              }
            });
            aiHistory.appendChild(entry);
          });
      }
      renderHistory();

      // --- Loading Spinner ---
      function showSpinner() {
        aiResponse.innerHTML =
          '<span class="spinner" aria-label="Loading"></span> <span>Thinking...</span>';
      }

      // --- AI Form Submission ---
      aiForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const prompt = aiPrompt.value.trim();
        if (!prompt) return;
        if (prompt.length > 1000) {
          aiResponse.textContent = "Prompt too long (max 1000 characters).";
          return;
        }
        showSpinner();

        try {
          const token = getAuthToken();
          const res = await fetch("/api/ollama", {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ prompt }),
          });

          if (!res.ok) {
            throw new Error("AI server not available");
          }

          const data = await res.json();
          const response = data.response || data.error || "No response";

          // Add to history and save
          chatHistory.push({ prompt, response });
          saveHistory(chatHistory);
          renderHistory();

          // Clear prompt and response area
          aiPrompt.value = "";
          aiResponse.textContent = "";
        } catch (err) {
          aiResponse.textContent =
            "⚠️ AI server is not running or not installed. Please start or install the AI backend to use this feature.";
        }
      });

      // --- Keyboard Shortcut: Ctrl+Enter or Cmd+Enter to send ---
      aiPrompt.addEventListener("keydown", function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          aiForm.requestSubmit();
        }
      });

      // --- Download History as TXT ---
      document
        .getElementById("downloadHistory")
        .addEventListener("click", () => {
          let txt = "";
          chatHistory.forEach((item, i) => {
            txt += `Prompt ${i + 1}:\n${item.prompt}\n\nResponse ${i + 1}:\n${
              item.response
            }\n\n---\n\n`;
          });
          const blob = new Blob([txt], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "ai-chat-history.txt";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        });

      // --- Clear History Button ---
      document.getElementById("clearHistory").addEventListener("click", () => {
        if (confirm("Clear all chat history?")) {
          chatHistory = [];
          saveHistory(chatHistory);
          renderHistory();
        }
      });

      // --- Help Modal Logic & Accessibility ---
      const helpBtn = document.getElementById("helpBtn");
      const helpModal = document.getElementById("helpModal");
      const closeHelpModal = document.getElementById("closeHelpModal");
      helpBtn.addEventListener("click", () => {
        helpModal.style.display = "flex";
        helpModal.focus();
      });
      closeHelpModal.addEventListener("click", () => {
        helpModal.style.display = "none";
        helpBtn.focus();
      });
      helpModal.addEventListener("click", (e) => {
        if (e.target === helpModal) helpModal.style.display = "none";
      });
      // ESC to close modal
      document.addEventListener("keydown", (e) => {
        if (
          helpModal.style.display === "flex" &&
          (e.key === "Escape" || e.key === "Esc")
        ) {
          helpModal.style.display = "none";
          helpBtn.focus();
        }
      });

      // --- Tailored Resume Functionality ---
      // Check if we have a tailored resume prompt to load
      function loadTailoredResumePrompt() {
        const tailoredPrompt = localStorage.getItem('tailoredResumePrompt');
        const jobTitle = localStorage.getItem('tailoredResumeJobTitle');
        const company = localStorage.getItem('tailoredResumeCompany');
        
        if (tailoredPrompt) {
          // Pre-fill the AI prompt with the tailored resume request
          aiPrompt.value = tailoredPrompt;
          
          // Update the page title to show we're in tailored resume mode
          if (jobTitle && company) {
            document.title = `Tailor Resume for ${jobTitle} at ${company} - AI Assistant`;
          }
          
          // Clear the stored data so it doesn't persist on page refresh
          localStorage.removeItem('tailoredResumePrompt');
          localStorage.removeItem('tailoredResumeJobTitle');
          localStorage.removeItem('tailoredResumeCompany');
          
          // Focus the prompt input
          aiPrompt.focus();
          
          // Show a toast notification if available
          if (window.toast) {
            window.toast.info('Tailored resume prompt loaded! Click "Ask AI" to get personalized resume tips.');
          }
        }
      }

      // Load tailored resume prompt on page load
      loadTailoredResumePrompt();
    </script>
  </body>
</html>
